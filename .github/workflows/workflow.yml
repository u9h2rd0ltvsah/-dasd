name: Ultra Fast Android Cloud Phone

on:
  workflow_dispatch:
    inputs:
      device_name:
        description: 'Device Name'
        required: true
        default: 'android-ultra-fast'

env:
  DEVICE_NAME: ${{ github.event.inputs.device_name || 'android-ultra-fast' }}

jobs:
  deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      actions: write

    steps:
    - name: Ultra Fast Environment Setup
      run: |
        echo "⚡ Ultra-fast environment optimization..."

        # Aggressive space cleanup
        sudo rm -rf /usr/share/dotnet /opt/ghc /usr/local/share/boost /usr/local/lib/android /opt/hostedtoolcache /usr/lib/jvm &
        sudo apt-get autoremove -y && sudo apt-get clean

        # Minimal KVM setup
        sudo apt-get update -qq
        sudo apt-get install -y qemu-kvm libvirt-daemon-system

        echo "✅ Environment ultra-optimized!"

    - name: Launch Ultra Fast Android
      run: |
        echo "🚀🚀🚀 Launching ULTRA FAST Android Cloud Phone..."

        # Use lightning-fast Android-x86 container
        echo "📥 Pulling ultra-fast Android image..."
        docker pull us-docker.pkg.dev/android-emulator-268719/system-images/android:30-google-x64 || \
        docker pull budtmo/docker-android-x86-9.0 || \
        docker pull kasmweb/android:1.14.0

        # Ultra-fast container launch with maximum performance
        echo "⚡ Starting with maximum performance settings..."
        docker run -d --privileged --name android-ultra \
          -p 6080:6080 -p 5900:5900 \
          --device /dev/kvm \
          --cpus=4 \
          --memory=16g \
          --shm-size=2g \
          us-docker.pkg.dev/android-emulator-268719/system-images/android:30-google-x64 || \
        docker run -d --privileged --name android-ultra \
          -p 6080:6080 \
          --device /dev/kvm \
          --cpus=4 \
          --memory=16g \
          budtmo/docker-android-x86-9.0 || \
        docker run -d --privileged --name android-ultra \
          -p 6901:6901 \
          kasmweb/android:1.14.0

        echo "⚡ Ultra-fast boot detection..."

        # Lightning-fast detection
        for attempt in {1..20}; do
          if curl -f -s http://localhost:6080 > /dev/null 2>&1 || \
             curl -f -s http://localhost:6901 > /dev/null 2>&1; then
            echo "✅ Android ready in $((attempt * 3)) seconds!"
            break
          fi
          echo "🔄 Booting ultra-fast... ($attempt/20)"
          sleep 3
        done

        echo ""
        echo "🎉🎉🎉🎉🎉🎉🎉🎉🎉🎉🎉🎉🎉🎉🎉🎉"
        echo "✅ ULTRA FAST ANDROID CLOUD PHONE READY!"
        echo "⚡ Maximum performance - No lag, no disconnects!"
        echo "🚀 Lightning-fast boot completed!"
        echo "🎉🎉🎉🎉🎉🎉🎉🎉🎉🎉🎉🎉🎉🎉🎉🎉"
        echo ""

    - name: Ultra Fast Tunnel Setup
      run: |
        echo "🌐 Setting up ultra-fast tunnel..."

        # Download cloudflared
        curl -L https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-linux-amd64 -o cloudflared
        chmod +x cloudflared

        # Start ultra-fast tunnel
        ./cloudflared tunnel --url http://localhost:6080 --no-autoupdate &
        sleep 5

        echo "✅ Tunnel active - Check logs for URL"
        echo "⚡ Ultra-fast connection established!"

    - name: Maintain Ultra Fast Performance
      run: |
        echo "🎯 Ultra Fast Android Session Running!"
        echo "⚡ Maximum performance maintained"
        echo ""

        # Run for 6 hours with minimal monitoring
        for hour in {1..6}; do
          for minute in {1..60}; do
            total_minutes=$(( (hour-1)*60 + minute ))
            echo "🟢 Ultra Fast - Hour $hour, Minute $minute"

            # Light health check every 30 minutes
            if [ $((total_minutes % 30)) -eq 0 ]; then
              if ! docker ps -q -f name=android-ultra | grep -q .; then
                echo "🔄 Quick restart..."
                docker restart android-ultra
              fi
            fi

            sleep 60
          done
        done

        echo "⏰ Ultra fast session completed!"

        # Quick cleanup
        pkill cloudflared 2>/dev/null || true
        docker stop android-ultra 2>/dev/null || true
        docker rm android-ultra 2>/dev/null || true
