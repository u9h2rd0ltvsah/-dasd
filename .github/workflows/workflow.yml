name: Android Cloud Server Setup

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  setup-android-server:
    runs-on: ubuntu-latest
    container:
      image: budtmo/docker-android:emulator_9.0
      options: --privileged
    services:
      docker:
        image: docker:dind
    steps:
    - name: Wait for emulator to start
      run: |
        export ANDROID_HOME=/tmp/android
        mkdir -p $ANDROID_HOME
        sleep 30
        adb devices
        adb shell settings put global animator_duration_scale 0.0
        adb shell settings put global transition_animation_scale 0.0
        adb shell settings put global window_animation_scale 0.0

    - name: Install Cloudflare Tunnel
      run: |
        apt-get update
        apt-get install -y wget
        wget -q https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-linux-amd64.deb
        dpkg -i cloudflared-linux-amd64.deb

    - name: Authenticate and start Cloudflare Tunnel for VNC
      run: |
        cloudflared tunnel login --token ${{ secrets.CLOUDFLARE_TOKEN }}
        cloudflared tunnel create android-vnc || echo "Tunnel may already exist"
        cloudflared tunnel route dns android-vnc yourdomain.com
        cloudflared tunnel run android-vnc &
      env:
        CLOUDFLARE_TOKEN: ${{ secrets.CLOUDFLARE_TOKEN }}

    - name: Keep workflow running
      run: |
        while true; do sleep 60; done
