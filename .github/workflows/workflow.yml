name: Android Cloud Server Setup

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  setup-android-server:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout repository
      uses: actions/checkout@v3

    - name: Set up JDK 8
      uses: actions/setup-java@v3
      with:
        java-version: '8'
        distribution: 'temurin'

    - name: Cache Android SDK
      uses: actions/cache@v3
      with:
        path: |
          ~/.android/sdk
          ~/.android/avd
        key: android-sdk-${{ runner.os }}-v1
        restore-keys: |
          android-sdk-${{ runner.os }}-

    - name: Set up Android SDK
      uses: android-actions/setup-android@v2

    - name: Install Android 9 system image
      run: |
        echo "y" | $ANDROID_HOME/tools/bin/sdkmanager --install 'system-images;android-28;google_apis;x86'

    - name: Create Android Virtual Device (AVD)
      run: |
        echo "no" | $ANDROID_HOME/tools/bin/avdmanager create avd -n android9 -k 'system-images;android-28;google_apis;x86' --device "pixel"

    - name: Start Android Emulator with high resources
      run: |
        $ANDROID_HOME/emulator/emulator -avd android9 -no-audio -gpu swiftshader_indirect -qemu -enable-kvm -m 8192 -smp 8 &
        sleep 30
        adb wait-for-device
        adb shell settings put global animator_duration_scale 0.0
        adb shell settings put global transition_animation_scale 0.0
        adb shell settings put global window_animation_scale 0.0

    - name: Install VNC and noVNC for smooth remote control
      run: |
        sudo apt-get update
        sudo apt-get install -y tightvncserver novnc websockify x11vnc

    - name: Set up VNC server
      run: |
        mkdir -p ~/.vnc
        echo "password" | vncpasswd -f > ~/.vnc/passwd
        chmod 600 ~/.vnc/passwd
        vncserver :1 -geometry 1280x720 -depth 24
        x11vnc -display :1 -forever -shared -rfbport 5901 &

    - name: Start noVNC web interface
      run: |
        websockify --web /usr/share/novnc 8080 localhost:5901 &
        sleep 5

    - name: Install Cloudflare Tunnel
      run: |
        wget -q https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-linux-amd64.deb
        sudo dpkg -i cloudflared-linux-amd64.deb

    - name: Authenticate and start Cloudflare Tunnel for VNC
      run: |
        cloudflared tunnel login --token ${{ secrets.CLOUDFLARE_TOKEN }}
        cloudflared tunnel create android-vnc || echo "Tunnel may already exist"
        cloudflared tunnel route dns android-vnc yourdomain.com
        cloudflared tunnel run android-vnc &
      env:
        CLOUDFLARE_TOKEN: ${{ secrets.CLOUDFLARE_TOKEN }}

    - name: Keep workflow running
      run: |
        while true; do sleep 60; done
