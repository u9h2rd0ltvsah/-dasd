name: Android Cloud Server Setup

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  setup-android-server:
    runs-on: ubuntu-latest
    container:
      image: budtmo/docker-android:emulator_9.0
      options: --privileged
    steps:
    - name: Setup Android Cloud with Tunnel
      run: |
        echo "Waiting for Android emulator to start..."
        sleep 180
        echo "Checking emulator status..."
        ps aux | grep emulator || echo "Emulator not running"
        netstat -tlnp || echo "No listening ports"
        echo "Setting Android environment..."
        export ANDROID_AVD_HOME=/tmp/.android/avd
        export ANDROID_SDK_HOME=/tmp
        mkdir -p /tmp/.android/avd
        echo "Listing available AVDs..."
        emulator -list-avds
        echo "Creating AVD if none exist..."
        echo "no" | avdmanager create avd -n test -k 'system-images;android-28;google_apis;x86_64' || echo "AVD creation failed"
        echo "Listing AVDs after creation..."
        emulator -list-avds
        echo "Trying to start emulator manually..."
        emulator -avd test -no-window -no-audio -gpu swiftshader_indirect -qemu -enable-kvm &
        sleep 30
        echo "Downloading noVNC..."
        curl -L -o /tmp/master.zip https://github.com/novnc/noVNC/archive/refs/heads/master.zip
        unzip -q /tmp/master.zip -d /tmp
        echo "Setting up virtual environment..."
        python3 -m venv /tmp/venv
        /tmp/venv/bin/pip install websockify
        echo "Starting noVNC web interface..."
        /tmp/venv/bin/websockify --web /tmp/noVNC-master 6080 localhost:5900 &
        sleep 10
        echo "Checking noVNC service..."
        curl -s localhost:6080 > /dev/null && echo "noVNC is running" || echo "noVNC not responding"
        echo "Installing Cloudflare Tunnel..."
        curl -L -o /tmp/cloudflared https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-linux-amd64
        chmod +x /tmp/cloudflared
        echo "Starting Cloudflare tunnel..."
        /tmp/cloudflared tunnel --url localhost:6080 &
        sleep 5
        echo "Cloudflare tunnel started. Check the logs above for the temporary URL to access noVNC web interface."
        while true; do sleep 60; done
