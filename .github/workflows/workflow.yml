name: Ultra Fast Android Cloud Phone

on:
  workflow_dispatch:
    inputs:
      device_name:
        description: 'Device Name'
        required: true
        default: 'android-ultra-fast'

env:
  DEVICE_NAME: ${{ github.event.inputs.device_name || 'android-ultra-fast' }}

jobs:
  deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      actions: write

    steps:
    - name: Ultra Fast Environment Setup
      run: |
        echo "âš¡ Ultra-fast environment optimization..."

        # Aggressive space cleanup
        sudo rm -rf /usr/share/dotnet /opt/ghc /usr/local/share/boost /usr/local/lib/android /opt/hostedtoolcache /usr/lib/jvm &
        sudo apt-get autoremove -y && sudo apt-get clean

        # Minimal KVM setup
        sudo apt-get update -qq
        sudo apt-get install -y qemu-kvm libvirt-daemon-system

        echo "âœ… Environment ultra-optimized!"

    - name: Launch Ultra Fast Android
      run: |
        echo "ðŸš€ðŸš€ðŸš€ Launching ULTRA FAST Android Cloud Phone..."

        # Use proven high-performance Android container
        echo "ðŸ“¥ Pulling ultra-fast Android 9 image..."
        docker pull budtmo/docker-android:emulator_9.0

        # Maximum performance container launch with FULL resource utilization
        echo "âš¡ Starting with MAXIMUM performance settings - Using ALL GitHub resources..."
        docker run -d --privileged --name android-ultra \
          -p 6080:6080 -p 5554:5554 -p 5555:5555 \
          -e EMULATOR_DEVICE="Nexus 5" \
          -e WEB_VNC=true \
          -e APPIUM=false \
          -e CONNECT_TO_GRID=false \
          -e EMULATOR_ARGS="-no-audio -no-window -gpu swiftshader_indirect -no-snapshot -noaudio -no-boot-anim -memory 14336 -cores 4 -qemu -enable-kvm -qemu -cpu host" \
          --device /dev/kvm \
          --cpus=4 \
          --memory=16g \
          --shm-size=2g \
          budtmo/docker-android:emulator_9.0

        echo "âš¡ Ultra-fast boot detection with maximum performance..."

        # Lightning-fast detection with performance monitoring
        for attempt in {1..25}; do
          if curl -f -s http://localhost:6080 > /dev/null 2>&1; then
            echo "âœ… Android ready in $((attempt * 4)) seconds!"

            # Performance verification
            echo "ðŸ” Performance check..."
            docker exec android-ultra adb shell getprop ro.build.version.release 2>/dev/null || echo "ADB not ready yet"
            break
          fi
          echo "ðŸ”„ Booting ultra-fast... ($attempt/25)"
          sleep 4
        done

        echo ""
        echo "ðŸŽ‰ðŸŽ‰ðŸŽ‰ðŸŽ‰ðŸŽ‰ðŸŽ‰ðŸŽ‰ðŸŽ‰ðŸŽ‰ðŸŽ‰ðŸŽ‰ðŸŽ‰ðŸŽ‰ðŸŽ‰ðŸŽ‰ðŸŽ‰"
        echo "âœ… ULTRA FAST ANDROID 9 CLOUD PHONE READY!"
        echo "âš¡ Maximum performance - 16GB RAM, 4 CPU cores!"
        echo "ðŸš€ Lightning-fast boot with hardware acceleration!"
        echo "ðŸŽ® Optimized for gaming - No lag, buttery smooth!"
        echo "ðŸŽ‰ðŸŽ‰ðŸŽ‰ðŸŽ‰ðŸŽ‰ðŸŽ‰ðŸŽ‰ðŸŽ‰ðŸŽ‰ðŸŽ‰ðŸŽ‰ðŸŽ‰ðŸŽ‰ðŸŽ‰ðŸŽ‰ðŸŽ‰"
        echo ""

    - name: Ultra Fast Tunnel Setup
      run: |
        echo "ðŸŒ Setting up ultra-fast tunnel..."

        # Download cloudflared
        curl -L https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-linux-amd64 -o cloudflared
        chmod +x cloudflared

        # Start ultra-fast tunnel
        ./cloudflared tunnel --url http://localhost:6080 --no-autoupdate &
        sleep 5

        echo "âœ… Tunnel active - Check logs for URL"
        echo "âš¡ Ultra-fast connection established!"

    - name: Maintain Ultra Fast Performance
      run: |
        echo "ðŸŽ¯ Ultra Fast Android Session Running!"
        echo "âš¡ Maximum performance maintained"
        echo ""

        # Run for 6 hours with minimal monitoring
        for hour in {1..6}; do
          for minute in {1..60}; do
            total_minutes=$(( (hour-1)*60 + minute ))
            echo "ðŸŸ¢ Ultra Fast - Hour $hour, Minute $minute"

            # Light health check every 30 minutes
            if [ $((total_minutes % 30)) -eq 0 ]; then
              if ! docker ps -q -f name=android-ultra | grep -q .; then
                echo "ðŸ”„ Quick restart..."
                docker restart android-ultra
              fi
            fi

            sleep 60
          done
        done

        echo "â° Ultra fast session completed!"

        # Quick cleanup
        pkill cloudflared 2>/dev/null || true
        docker stop android-ultra 2>/dev/null || true
        docker rm android-ultra 2>/dev/null || true
