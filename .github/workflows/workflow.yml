name: Android Cloud Server Setup

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  setup-android-server:
    runs-on: ubuntu-latest
    container:
      image: us-docker.pkg.dev/android-emulator-268719/system-images/android:30-google-x64
      options: --privileged --device /dev/kvm
    steps:
    - name: Checkout repository
      uses: actions/checkout@v3

    - name: Start Android Emulator with high resources
      run: |
        emulator -avd android30 -no-audio -gpu swiftshader_indirect -qemu -enable-kvm -m 8192 -smp 8 -ports 5554,5555 &
        sleep 30
        adb wait-for-device
        adb shell settings put global animator_duration_scale 0.0
        adb shell settings put global transition_animation_scale 0.0
        adb shell settings put global window_animation_scale 0.0

    - name: Install VNC and noVNC for smooth remote control
      run: |
        apt-get update
        apt-get install -y tightvncserver novnc websockify x11vnc

    - name: Set up VNC server
      run: |
        mkdir -p ~/.vnc
        echo "password" | vncpasswd -f > ~/.vnc/passwd
        chmod 600 ~/.vnc/passwd
        vncserver :1 -geometry 1280x720 -depth 24
        x11vnc -display :1 -forever -shared -rfbport 5901 &

    - name: Start noVNC web interface
      run: |
        websockify --web /usr/share/novnc 8080 localhost:5901 &
        sleep 5

    - name: Install Cloudflare Tunnel
      run: |
        wget -q https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-linux-amd64.deb
        dpkg -i cloudflared-linux-amd64.deb

    - name: Authenticate and start Cloudflare Tunnel for VNC
      run: |
        cloudflared tunnel login --token ${{ secrets.CLOUDFLARE_TOKEN }}
        cloudflared tunnel create android-vnc || echo "Tunnel may already exist"
        cloudflared tunnel route dns android-vnc yourdomain.com
        cloudflared tunnel run android-vnc &
      env:
        CLOUDFLARE_TOKEN: ${{ secrets.CLOUDFLARE_TOKEN }}

    - name: Keep workflow running
      run: |
        while true; do sleep 60; done
